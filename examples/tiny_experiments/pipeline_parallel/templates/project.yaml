-- extends 'projects/tiny.yaml'

## Common project settings
[config_metadata]
    == super()
    -- set ns.model_name = "test_model"
    -- set ns.dataset_config = "tinystories-iter.yaml"
    -- set ns.model_project_dir = joinpath(project_dir, 'models/causal')
    -- set ns.model_project_config = "pipeline_model.yaml"

[trainer_definition]
    -- include 'project.trainer_config'

[trainer_callbacks]
    -- include 'project.callbacks'

[trainer_args]
    == super()
    # Project Overrides
    per_device_train_batch_size: 64
    per_device_eval_batch_size: 64
    logging_steps: 10
    eval_steps: 50
    max_steps: {{ max_steps | default(250) }}
    default_dtype: "bfloat16"

[datacollator]
# Pipeline Parallel requires constant input tensor shapes. Use the datacollator to
# generate constant sequence length batches, padding if too short and truncating if too long.
data_collator: &data_collator !singleton:forgather.ml.data_collator:DataCollatorForCausalLM@DataCollatorForCausalLM
    tokenizer: *tokenizer
    return_tensors: pt
    padding: "max_length"
    truncation: True
    max_length: 512

[optimizer]
optimizer: &optimizer !partial:forgather.ml.optim.adafactor:Adafactor
    lr: 1.0e-3
    weight_decay: 0.01

#-------------------- project.trainer_config --------------------
-- extends 'tiny.trainer_config'

#-------------------- project.callbacks --------------------
-- extends 'tiny.callbacks'

[callback_list]
    == super()
    text_gen_callback: null # Disable text generation callback; not compatible with pipeline trainer.
