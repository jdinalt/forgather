-- extends 'models/causal_lm/custom_dynamic.yaml'

[model_meta_config]
    == super()
    -- set ns.model_name = "Deep One"
    -- set ns.model_description = "A big Deepnet model with ALiBi attention."
    -- set ns.model_short_name = "deepone"

[model_tokenizer]
    -- include 'tokenizers/wikitext/32k.yaml'

[model_bits]
    [loss_fn]
.define: &loss_fn !singleton:.causal_loss:CausalLoss@loss_fn

    [layer_norm_factory]
.define: &layer_norm_factory !partial:torch.nn:RMSNorm@layer_norm_factory
    normalized_shape: !var "hidden_size"
    eps: !var "rms_norm_eps"

    [feedforward_factory]
.define: &feedforward_factory !partial:.glu_feedforward:GLUFeedforwardLayer@feedforward_factory
    d_model: !var "hidden_size"
    d_feedforward: !var "intermediate_size"
    activation_factory: !partial:torch.nn.ReLU
    dropout: !var "activation_dropout"

    [rel_positional_encoder]
.define: &relative_pe null

    [qk_norm_factory]
.define: &qk_norm_factory null

    [flex_attn_kernel_options]
    -- include "flex_kernel_options/default.yaml"

    [attn_functions]
.define: &attn_functions !dict
    # The default HF implementations don't support ALiBi attention, while
    # all of Forgather's implementations do.
    eager: !partial:.attention_interface:eager_attention_forward
    flex_attention: !partial:.attention_interface:flex_attention_forward
        kernel_options: !var "flex_attn_kernel_options"
    sdpa: !partial:.attention_interface:sdpa_attention_forward
    # This implementation does not support packed examples or trainable ALIBi
    # ...but's it's the fastest for inference with ALiBi
    flash_attention_2: !partial:.attention_interface:flash_attn_2_forward

    [attention_factory]
.define: &attention_factory !partial:.causal_alibi_attn:CausalAlibiAttn@attention_factory
    d_model: !var "hidden_size"
    num_heads: !var "num_attention_heads"
    dropout: !var "attention_dropout"
    bias: False
    attn_implementation: !var "attn_implementation" # Value from &model_constructor_args
    attn_functions: *attn_functions
    sliding_window: !var "sliding_window"
    # Make the ALiBi biases trainable weights
    trainable_alibi: True
    # Use alternative initialization for better trainable slope behavior
    alt_alibi_init: True

    [layer_factory]
.define: &layer_factory !partial:.deepnet:DeepnetLayer@layer_factory
    feedforward_factory: *feedforward_factory
    attention_factory: *attention_factory
    norm_factory: *layer_norm_factory
    dropout: !var "layer_dropout"
    residual_dropout: !var "residual_dropout"
    alpha: !call:.deepnet:deepnet_alpha [ !var "num_hidden_layers", 0 ]

    [layer_stack]
.define: &layer_stack !factory:.checkpoint_layer_stack:LayerStack@layer_stack
    layer_factory: *layer_factory
    num_hidden_layers: !var "num_hidden_layers"
    post_norm_factory: *layer_norm_factory
    enable_checkpoint: !var "enable_activation_checkpoint"
    checkpoint_stride: !var "checkpoint_stride"

    [output_decoder]
.define: &output_decoder !partial:torch.nn:Linear@output_decoder
    in_features: !var "hidden_size"
    out_features: !var "vocab_size"
    bias: False

    [abs_positional_encoder]
.define: &absolute_pe null

    [embedding]
.define: &embedding !call:torch.nn.Embedding
    num_embeddings: !var "vocab_size"
    embedding_dim: !var "hidden_size"
    padding_idx: !var "pad_token_id"

    [input_encoder]
.define: &input_encoder !factory:.input_encoder:InputEncoder@input_encoder
    d_model: !var "hidden_size"
    embedding: *embedding
    dropout: !var "embedding_dropout"
    positional_encoder: *absolute_pe

    [init_weights]
        [init_regex_list]
.define: &init_regex_list !dlist
    zeros: 
        - 'bias'
        - !partial:torch.nn.init:zeros_
    deepnet:
        - 'ff\.|attn.value.weight|attn.output.weight'
        - !partial:torch.nn.init:xavier_uniform_
            gain: !call:.deepnet:deepnet_beta [ !var "num_hidden_layers", 0 ]
    linear:
        - 'attn.key.weight|attn.query.weight'
        - !partial:torch.nn.init:xavier_uniform_
    embedding:
        - 'embedding.weight'
        - !partial:.init_weights:init_embeddings
            padding_index: !var "pad_token_id"
            scale_rsqrt_d_model: False

        [init_function]
.define: &init_weights !partial:.init_weights:init_weights_by_regex@init_weights
    regex_list: *init_regex_list
    debug: True

    [attn_mask_fn]
.define: &attn_mask_fn !partial:.causal_mask:causal_mask@attn_mask_fn

    [model_factory]
model_factory: &model_factory !dict@model_factory
    causal_model: !partial:.causal_lm:CasualLM
        config: !var "config"
        input_encoder: *input_encoder
        layer_stack: *layer_stack
        init_weights: *init_weights
        attn_mask_fn: *attn_mask_fn
    lm_head: *output_decoder
    loss_fn: *loss_fn

[model_config]
    == super()
    hidden_size: {{ hidden_size | toyaml(2048) }}
    num_attention_heads: {{ num_attention_heads | toyaml(16) }}
    num_hidden_layers: {{ num_hidden_layers | toyaml(32) }}
    max_position_embeddings: !singleton:getattr
        - *tokenizer
        - "model_max_length"
    intermediate_size: {{ intermediate_size | toyaml(5376) }}
    embedding_dropout: {{ embedding_dropout | toyaml(0.0) }}
    rms_norm_eps: {{ rms_norm_eps | toyaml(1.0e-06) }}
    layer_dropout: {{ layer_dropout | toyaml(0.0) }}
    residual_dropout: {{ residual_dropout | toyaml(0.0) }}
    attention_dropout: {{ attention_dropout | toyaml(0.0) }}
    activation_dropout: {{ activation_dropout | toyaml(0.0) }}
    enable_activation_checkpoint: False
    checkpoint_stride: 1
    tie_word_embeddings: {{ tie_word_embeddings | toyaml(False) }}
    sliding_window: {{ sliding_window | toyaml(None) }}
    flex_attn_kernel_options: *flex_attn_kernel_options

[model_code_generator]
    == super()
    # Deepone
    supports_gradient_checkpointing: True
    supports_sdpa: True
    supports_flash_attn: True
    supports_flex_attn: True
    supports_attention_backend: False
    tied_weights_keys: {causal_lm.input_encoder.embedding.weight: "lm_head.weight"}
    no_split_modules: ["DeepnetLayer"]
    
    # vLLM Support
    # While this should be correct, vLLM does not work at present with this model.
    # The issue is the use of ALiBI relative positional encoding, as there does not
    # appear to be support for this in their "transformers" compatibility layer.
    # vLLM natively support this, but this would take time to complete.
    tp_plan:
        "causal_lm.layer_stack.layers.*.attention.query_linear": "colwise"
        "causal_lm.layer_stack.layers.*.attention.key_linear": "colwise"
        "causal_lm.layer_stack.layers.*.attention.value_linear": "colwise"
        "causal_lm.layer_stack.layers.*.attention.output_linear": "rowwise"
        "causal_lm.layer_stack.layers.*.feedforward.gate_proj": "colwise"
        "causal_lm.layer_stack.layers.*.feedforward.up_proj": "colwise"
        "causal_lm.layer_stack.layers.*.feedforward.down_proj": "rowwise"
    pp_plan:
        "causal_lm.input_encoder":
            - ["input_ids"]
            - ["hidden_states"]
        "causal_lm.layer_stack.layers":
            - ["hidden_states", "attention_mask"]
            - ["hidden_states"]
    
    
