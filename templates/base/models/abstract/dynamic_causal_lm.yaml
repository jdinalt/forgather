-- extends 'models/abstract/custom_causal_lm.yaml'

-- block model_meta_config
    == super()
    -- set model_def.name = "Dynamic Causal Languange Model"
    ## Used to name the generated model file and to set the HF model type.
    -- set model_def.short_name = "dynamic_causal_lm"
    ## Where to search for model source templates.
    -- set model_def.model_template_searchpath = joinpath(ns.forgather_dir, 'model_src')
    ## The name of the model source template to use
    -- set model_def.model_template_name = 'dynamic_causal_template.py'
    -- set model_def.description = "This model's implemetation modules can be swapped out entirely through the configuraiton."
    -- set model_def.cls = 'DynamicCasualLM'
    -- set model_def.cfg_cls = 'DynamicCausalLMConfig'
    ## path to file containing configuration class; be default, we assume they are the same.
    ## Code generation naming policy:
    ##   "required" : Only assign names to objects when they show up in more than on place in the graph.
    ##     This results in the most compact representation.
    ##   "named" : Assign names when required or if the object has been named in the definition.
    ##   "all" : Assign names to all objects; generate automatic names, when not specified.
    ##     This results in a very flat structure, but the hierarchy may not be readily apparent
    ##     and the is very verbose.
    -- set model_def.name_policy = "named"
-- endblock model_meta_config


-- block model_globals
    -- set model_def.model_path = joinpath(ns.output_dir, model_def.short_name + ".py")
    -- set model_def.config_path = model_def.model_path
    -- set model_def.model_type = "forgather-dynamic-causal-" + model_def.short_name
    -- set model_def.bits_dir = joinpath(ns.forgather_dir, 'model_src', 'bits')
<< endblock model_globals


-- block model_header
    == super()
# model_def.short_name = "{{ model_def.short_name }}"
# model_def.model_type = "{{ model_def.model_type }}"
# model_def.model_path = "{{ model_def.model_path }}"
# model_def.model_template_searchpath = "{{ abspath(model_def.model_template_searchpath) }}"
# model_def.model_template_name = "{{ model_def.model_template_name }}"
# model_def.name_policy = "{{ model_def.name_policy }}"
<< endblock model_header


## Note reversed order of super(), as we want to search from specific to general
-- block model_submodule_searchpath
    - "{{ model_def.bits_dir }}"
    == super()
<< endblock model_submodule_searchpath


-- block model_bits required
## .define: &model_factory !singleton:.dynamic_causal_transformer:CasualLM@model_factory
<< endblock model_bits


-- block model_code_generator
.define: &model_code_writer !singleton:forgather.ml.construct:write_file@model_code_writer
    data: &model_code_generator !meta:forgather.codegen:generate_code@model_code_generator
        searchpath: "{{ model_def.model_template_searchpath }}"
        template_name: "{{ model_def.model_template_name }}"
        name_policy: "{{ model_def.name_policy }}"
        obj: *model_factory
        # Template args
        model_type: "{{ model_def.model_type }}"
    output_file: "{{ model_def.model_path }}"
    return_value: "Model constructor generated by Forgather 1.0"
-- endblock model_code_generator


-- block model_config
    == super()
    # Add dependency on code generator
    code_generator: *model_code_writer
<< endblock model_config

