## This is an example of a project template; useful where similar configurations
## may be used in multiple projects.
##
## Specifically, this sets up training for a very small model over one epoch
## on the 'abridged' version of the Tiny Stories dataset.
-- extends "types/training_script/causal_lm/causal_lm.yaml"

-- block config_metadata
    == super()
    ## Overrides
    -- set ns.CONFIG_NAME = "Tiny Experiments"
    -- set ns.CONFIG_DESCRIPTION = "A project template for running tiny model experiments."
    ## Defines
    -- set ns.trainer_class = 'trainers/trainer.yaml'
-- endblock config_metadata


## Setup base directories for the example projects
-- block base_directories
    -- set ASSETS_DIR = normpath(path_join(project_directory, '..', '..', '..'))
    -- include 'paths/default_paths.yaml'
-- endblock base_directories


-- block pre_model_setup
    == super()
    -- include "prompts/tiny_stories.yaml"
-- endblock pre_model_setup


-- block datasets_definition
    ## Note: Switch to 'datasets/tiny/tiny_stories.yaml' for the full dataset.
    -- include 'datasets/tiny/tiny_stories_abridged.yaml'
-- endblock datasets_definition


## Defaults to the basic trainer implementation
## Note: This is unsuitable for multiple GPUs.
## Override 'ns.trainer_class' to change the trainer class.
-- block trainer_definition
    -- include 'tiny.trainer_config'
-- endblock trainer_definition


-- block construct_new_model
    -- include 'tiny.model_config'
-- endblock construct_new_model


-- block trainer_callbacks
    -- include 'tiny.callbacks'
<< endblock trainer_callbacks


#-------------------- tiny.trainer_config --------------------
-- extends ns.trainer_class

-- block trainer_meta_config
    == super()
    -- set trainer_def.name = "Custom " + trainer_def.name
-- endblock trainer_meta_config


-- block trainer_args
    == super()
    # Tiny Project Overrides
    per_device_train_batch_size: 64
    per_device_eval_batch_size: 64
    logging_steps: 100
    eval_steps: 500
-- endblock trainer_args

#-------------------- tiny.model_config --------------------
-- extends 'models/tiny/tiny.yaml'

#-------------------- tiny.callbacks --------------------
-- extends 'callbacks/loggers.yaml'

-- block callback_dependencies
    == super()

    -- filter trim()
    -- block text_gen_callback_args
.define: &text_gen_callback_args
    summary_writer: *summary_writer
    prompts: *testprompts
    generation_config: *generation_config
    max_new_tokens: 40
    generation_steps: 1000
    << endblock text_gen_callback_args
    -- endfilter
<< endblock callback_dependencies

-- block callback_list
    == super()
    - !callable:aiws.textgen_callback:TextgenCallback
        <<: *text_gen_callback_args
<< endblock callback_list