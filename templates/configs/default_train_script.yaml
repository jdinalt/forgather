{%- extends "configs/base_train_config.yaml" %}
{%- from 'inc/formatting.jinja' import h2, sep %}

{#- #############################
## Defaults
#################################}
{%- block experiment_defaults %}
{{ super() }}
-- set ns.CREATE_NEW_MODEL = True
-- set ns.SAVE_MODEL = False
{% endblock experiment_defaults -%}


{#- #############################
## Variable Definition List
#################################}
{% block variable_listing %}
{{ super() -}}
# ns.LOGGING_DIR: path = "{{ ns.LOGGING_DIR }}"
# ns.CREATE_NEW_MODEL: path = {{ ns.CREATE_NEW_MODEL }}
# ns.SAVE_MODEL: path = {{ ns.SAVE_MODEL }}
{% endblock variable_listing %}


{#- #############################
## Pre-model Setup
#################################}
{% block pre_model_setup %}
# Experiment tracking: Tensorboard SummaryWriter
.define: &summary_writer !callable:torch.utils.tensorboard:SummaryWriter
    - "{{ ns.LOGGING_DIR }}"
{% endblock pre_model_setup %}


##############################
## Model Definition
##############################
{%- block model_definition %}
-- if ns.CREATE_NEW_MODEL
{%- block construct_new_model %}
-- include 'models/custom_model.yaml'
{% endblock construct_new_model -%}
-- else
{%- block load_model %}
-- include 'models/load_custom_model.yaml'
{% endblock load_model -%}
-- endif
{% endblock model_definition -%}

##############################
## Dataset Definition
##############################
{%- block dataset_definition %}
-- include 'datasets/tiny_stories_pretokenized_2k.yaml'
{% endblock dataset_definition -%}


##############################
## Trainer Callbacks
##############################
{% block trainer_callbacks %}

.define: &trainer_callbacks
    - !callable:aiws.default_callbacks:JsonLogger []
    - !callable:aiws.tb_logger:TBLogger
        args: [ *summary_writer ]
        kwargs:
            date: "{{ utcnow }}"
            name: "{{ ns.EXPERIMENT_NAME }}"
            description: "{{ ns.EXPERIMENT_DESCRIPTION }}"
            args: {{script_args}}
            world_size: {{world_size}}
            config: !callable:pp_config
{% endblock trainer_callbacks %}


##############################
## Dataset Collator
##############################
{% block datacollator %}

.define: &data_collator !callable:transformers:DataCollatorForLanguageModeling
    args:
        - *tokenizer
    kwargs:
        mlm: False
        return_tensors: pt
{% endblock datacollator %}


##############################
## Trainer Definition
##############################
{%- block trainer_definition %}
-- include 'trainers/trainer.yaml'
{% endblock trainer_definition -%}


##############################
## Output Configuration
##############################
{%- block output_configuration %}
output_dir: "{{ ns.OUTPUT_DIR }}"
logging_dir: "{{ns.LOGGING_DIR}}"
experiment_name: "{{ ns.EXPERIMENT_NAME }}"
experiment_description: "{{ ns.EXPERIMENT_DESCRIPTION }}"
trainer: *trainer
do_save: {{ ns.SAVE_MODEL }}
{% endblock output_configuration -%}