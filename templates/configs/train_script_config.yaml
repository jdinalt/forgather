-- extends "configs/base_train_config.yaml"
-- from 'inc/formatting.jinja' import h2, sep


-- block experiment_defaults
    == super()
    -- set ns.CREATE_NEW_MODEL = True
    -- set ns.SAVE_MODEL = False
-- endblock experiment_defaults


-- block variable_listing
    == super()
# ns.LOGGING_DIR: path = "{{ ns.LOGGING_DIR }}"
# ns.CREATE_NEW_MODEL: path = {{ ns.CREATE_NEW_MODEL }}
# ns.SAVE_MODEL: path = {{ ns.SAVE_MODEL }}
-- endblock variable_listing


-- block pre_model_setup
# Experiment tracking: Tensorboard SummaryWriter
.define: &summary_writer !callable:torch.utils.tensorboard:SummaryWriter
    - "{{ ns.LOGGING_DIR }}"
-- endblock pre_model_setup


-- block model_definition
-- filter trim()
    -- if ns.CREATE_NEW_MODEL
        -- block construct_new_model
            -- include 'models/custom_model.yaml'
        << endblock construct_new_model
    -- else
        -- block load_model
            -- include 'models/load_custom_model.yaml'
        << endblock load_model
    -- endif
-- endfilter
-- endblock model_definition


-- block dataset_definition
    -- include 'datasets/tiny_stories_pretokenized_2k.yaml'
-- endblock dataset_definition


-- block trainer_callbacks
.define: &trainer_callbacks
    # Log training metrics to JSON fiie.
    - !callable:aiws.default_callbacks:JsonLogger []
    # Log configuration and metrics to Tensorboard file
    - !callable:aiws.tb_logger:TBLogger
        args: [ *summary_writer ]
        kwargs:
            date: "{{ utcnow }}"
            name: "{{ ns.EXPERIMENT_NAME }}"
            description: "{{ ns.EXPERIMENT_DESCRIPTION }}"
            args: {{script_args}}
            world_size: {{world_size}}
            config: !callable:pp_config
            versions: {{ versions }}
<< endblock trainer_callbacks


-- block datacollator
.define: &data_collator !callable:transformers:DataCollatorForLanguageModeling
    args:
        - *tokenizer
    kwargs:
        mlm: False
        return_tensors: pt
-- endblock datacollator


-- block trainer_definition
    -- include 'trainers/trainer.yaml'
-- endblock trainer_definition


-- block output_configuration
output_dir: "{{ ns.OUTPUT_DIR }}"
logging_dir: "{{ns.LOGGING_DIR}}"
experiment_name: "{{ ns.EXPERIMENT_NAME }}"
experiment_description: "{{ ns.EXPERIMENT_DESCRIPTION }}"
trainer: *trainer
do_save: {{ ns.SAVE_MODEL }}
-- endblock output_configuration